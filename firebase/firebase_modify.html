<script type="text/x-red" data-template-name="firebase modify">

    <div class="form-row">
        <label for="node-input-firebaseconfig"><i class="fa fa-database"></i> Firebase</label>
        <input type="text" id="node-input-firebaseconfig">
    </div>

   <div class="form-row">
        <label for="node-input-childpath"><i class="fa fa-sitemap"></i> Child Path</label>
        <input class="input-append-left" type="text" id="node-input-childpath" placeholder="path-to/the/data"">

    </div>

    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-terminal"></i> Method</label>
        .<select id="node-input-method" type="text" style="width:30%" text-center>
            <option value="set" default>set</option>
            <option value="push">push</option>
            <option value="update">update</option>
            <option value="remove">remove</option>
            <option value="setPriority">setPriority</option>
            <option value="setWithPriority">setWithPriority</option>
            <option value="msg.method">[msg.method]</option>
        </select>()
    </div>

    <div id="node-input-value-container" class="form-row">
      <label for="node-input-value"><i class="fa fa-file-text-o"></i> Value</label>
      <input id="node-input-value" autocomplete="off" type="text">
    </div>

    <div id="node-input-priority-container" class="form-row hidden">
      <label for="node-input-priority"><i class="fa fa-list-ol"></i> Priority</label>
      <input id="node-input-priority" autocomplete="off" type="text">
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="firebase modify">
   <p>Modifies or adds data to a Firebase location</p>
  
  <h3> Inputs </h3>
  <dl class="message-properties">
        <dt>Firebase Configuration
            <span class="property-type">config node</span>
        </dt>
        <dd> Supply a Firebase configuration and this node will watch for any changes at that location and generate messages </dd>
      <dt class="optional">Child Path <span class="property-type">string |msg | flow | global| jsonata </span></dt>
        <dd> the childpath of the database that can be used to dynamically set the .child() on the Firebase URL.</dd>

  <dt class="optional">Method<span class="property-type"></span></dt>
        
        <li> .set()
        <dd>  The contents of <code>msg.payload</code> are written to the Firebase Child Path,
        replacing whatever may already be there.  If the path was previously empty, a new record is made.
        The value of <code>msg.payload</code> can be an object, array, string, number, boolean, or null.</dd>
        </li>

        <li> .update()
        <dd>  For each key in the object, the Firebase reference will have the corresponding key set to the value in <code>msg.payload</code>, in effect updating the Firebase reference with the included keys and ignoring any keys that are missing from <code>msg.payload</code>.
        The value of <code>msg.payload</code> must be an object.</dd>
        </li>

        <li> .push()
        <dd>  The value of <code>msg.payload</code> is added to the Firebase reference as a new child reference with a unique key generated by Firebase
        </li>

        <li> .remove()
        <dd>  The data at the Firebase reference and all child data is removed immediately (no undo!).  This is equivalent to using <code>.set()</code> with <code>msg.payload</code> equal to null</dd>
        </li>

        

        <li> .setPriority()
        <dd>  The value of <code>msg.payload</code> is added to the Firebase reference as a new child reference with a unique key generated by Firebase. The value of <code>msg.payload</code> can be an object, array, string, number, boolean, or null.</dd>
        </li>
        
        <li> setWithPriority()
        <dd>  The data at the Firebase reference and all child data is removed immediately (no undo!).  This is equivalent to using <code>.set()</code> with <code>msg.payload</code> equal to null</dd>
        </li>

        <li> msg.method
        <dd>  The name of a message property that can be used to dynamically set the Firebase API method that is used.  This requires that the <code>method</code> property is set to <code>msg.method</code> in the node's edit dialog box.</dd>
        </li>

  </dl>   

  <h3> Output </h3>

    <dl class="message-properties">
          <dt>Original Message <span class="property-type">object</span></dt>
          <dd>The node's output port will send the original message once Firebase acknowledges that the Firebase has been written.
          If the .push() method is used, <code>msg.pushID</code> will contain the new pushID created on Firebase.> </dd>
  </dl>

  <h3>Details</h3>

    <p><strong><em>WARNING:</em></strong><br />
   It is possible to cause an endless loop if an upstream node watches the data set here.<br />
   (This node writes to "/foo", an upstream node watching "/foo" or / will generate a message leading this node to write to /foo.)
   </p>
   <p>If in doubt, add a Delay node.</p>
   
   <p>The node's output port will send the original message once Firebase acknowledges that the Firebase has been written.<br />
   If the .push() method is used, <code>msg.pushID</code> will contain the new pushID created on Firebase.
   </p>

   <h3>References</h3>
    <ul>
        <li>
       <a href="https://www.firebase.com/docs/web/api/firebase/set.html">Set Method Information</a>
       </li>
        <li>
       <a href="https://www.firebase.com/docs/web/api/firebase/update.html">Update Method Information</a>
       </li>
        <li>
       <a href="https://www.firebase.com/docs/web/api/firebase/push.html">Push Method Information</a>
       </li>
       <li>
       <a href="https://www.firebase.com/docs/web/api/firebase/remove.html">Remove Method Information</a>
       </li>
    
    </ul>

    

   
 

</script>

<script type="text/javascript">


    RED.nodes.registerType('firebase modify', {
        category: 'firebase',       // the palette category
        defaults: {                 // defines the editable properties of the node
            name: {value: ''},      //  along with default values.
            firebaseconfig:  {type:'firebase config',required:true},
            childpath: {value: '', required: false},
            childtype: {value: '', required: false},
            childvalue: {value: '', required: false},
            method: {value: 'set', required: true},
            value: {value:'msg.payload', required: true},
            priority: {value: 'msg.priority', required: false},
        },
        color: '#ffb37a',
        icon: 'firebase.png',       // saved in  icons/myicon.png
        align: 'right',
        inputs: 1,                  // set the number of inputs - only 0 or 1
        outputs: 1,                 // set the number of outputs - 0 to n

        label: function () {        // sets the default label contents
          var method = "." + this.method +"()"
          if(method == ".msg.method()")
            method = "[msg.method]()"

           var config = RED.nodes.node(this.firebaseconfig); //server side uses RED.nodes.getNode... go figure...

           // make sure the path starts with /
           var childpath = (this.childpath.indexOf("/") == 0) ? this.childpath : "/" + this.childpath;
           //make sure the path does not end with /
           childpath = childpath.substr(-1) == "/" ? childpath.slice(0,-1) : childpath

           //TODO: should we try to use the config nodes path and append to childpath or is that too long?
           return this.name ||
                 (config ? "https://"+config.firebaseurl+".firebaseio.com"+(childpath||"") + method : childpath + method) ||
                 "firebase" + method;
        },

        labelStyle: function () {   // sets the class to apply to the label
            return this.name ? "node_label_italic" : "";
        },

        oneditprepare: function(){

          var node = this;

          $("#node-input-childpath").typedInput({default: node.childtype,types:['str','msg','flow','global','jsonata']});

          //Set up autocomplete for Value field
          var defaultPayloadValues = [
            "msg.payload",
            "Firebase.ServerValue.TIMESTAMP"
          ];

          $('#node-input-value').autocomplete({
            source: defaultPayloadValues,
            minLength: 0
          });

          $('#node-input-value').on('focusin', function(){
            $(this).autocomplete("search", "");
            //$(this).autocomplete("search", $(this).val());
          });

          $('#node-input-value').on('focusout', function(){
            $(this).autocomplete("close");
          });

          //Set up autocomplete for Priority field
          var defaultPriorityValues = [
            "msg.priority",
          ];

          $('#node-input-priority').autocomplete({
            source: defaultPriorityValues,
            minLength: 0
          });

          $('#node-input-priority').on('focusin', function(){
            $(this).autocomplete("search", "");
          });

          $('#node-input-priority').on('focusout', function(){
            $(this).autocomplete("close");
          });

          //Set up change handler for Method field
          $('#node-input-method').on('change', function(){
            switch($(this).val()){
              case "set":
              case "push":
              case "update":
              case "remove":
              case "msg.method":
                $('#node-input-value-container').show();
                $('#node-input-priority-container').hide();
                break;
              case "setPriority":
                $('#node-input-value-container').hide();
                $('#node-input-priority-container').show();
                break;
              case "setWithPriority":
                $('#node-input-value-container').show();
                $('#node-input-priority-container').show();
                break;
              default:
                $('#node-input-value-container').show();
                $('#node-input-priority-container').hide();
                break;
            }
          });
        },
        oneditsave: function(){
          var node = this;
          node.childtype = $("#node-input-childpath").typedInput('type');
          node.childvalue = $("#node-input-childpath").typedInput('value');
        }
    });
</script>
