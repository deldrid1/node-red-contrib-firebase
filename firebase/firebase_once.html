<script type="text/x-red" data-template-name="firebase.once">

    <div class="form-row">
        <label for="node-input-firebaseconfig"><i class="fa fa-database"></i> Firebase</label>
        <input type="text" id="node-input-firebaseconfig">
    </div>

    <div class="form-row">
        <label for="node-input-childpath"><i class="fa fa-sitemap"></i> Child Path</label>
        <input class="input-append-left" type="text" id="node-input-childpath" placeholder="path-to/the/data">
    </div>

    <div class="form-row">
      <label for="eventType-select"><i class="fa fa-terminal"></i> Event Type</label>
      .once("
      <select id="eventType-select" style="width:35%">
          <option value="value">value</option>
          <option value="child_added">child_added</option>
          <option value="child_changed">child_changed</option>
          <option value="child_removed">child_removed</option>
          <option value="child_moved">child_moved</option>
          <option value="msg.eventType">[msg.eventType]</option>
      </select>
      ")
      <input type="hidden" id="node-input-eventType">
    </div>

    <!-- By convention, most nodes have a 'name' property. The following div -->
    <!-- provides the necessary field. Should always be the last option      -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="firebase.once">
   <p>Get data from Firebase via firebase.once()</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('firebase.once',{
        category: 'firebase',      // the palette category
        defaults: {             // defines the editable properties of the node
            name: {value:''},   //  along with default values.
            firebaseconfig:  {type:'firebase config',required:true},
            childpath: {value: '', required: false},
            eventType: {value: "value", required: true}
        },
        color: '#ffb37a',
        inputs:1,               // set the number of inputs - only 0 or 1
        outputs:1,              // set the number of outputs - 0 to n
        // set the icon (held in icons dir below where you save the node)
        icon: 'firebase.png',     // saved in  icons/myicon.png

        paletteLabel: "firebase.once()",

        label: function() {     // sets the default label contents
            //var config = RED.nodes.getNode(this.firebaseconfig);  //TODO: BUG: Doesn't appear to be a way to do this on the client side...

            // make sure the path starts with /
            var childpath = (this.childpath.indexOf("/") == 0) ? this.childpath : "/" + this.childpath;
            //make sure the path does not end with /
            childpath = childpath.substr(-1) == "/" ? childpath.slice(0,-1) : childpath

            //TODO: should we try to use the config nodes path and append to childpath or is that too long?
            return this.name ||
                   //"https://"+config.firebaseurl+"firebaseio.com/"+(this.childpath||"") + ".on(\""+this.eventType+"\")" ||
                   childpath + ".once(\""+this.eventType+"\")" ||
                   "firebase.once(\""+this.eventType+"\")";
        },
        labelStyle: function() { // sets the class to apply to the label
            return this.name?'node_label_italic':'';
        },

        oneditprepare: function() {
          //Update the eventType node-red property when the value is changed...
          $('#eventType-select').change(function () {
              $("#node-input-eventType").val($(this).find('option:selected').val())
          });

          //Set the select's to the node-red hidden properties
          $("#eventType-select").val($("#node-input-eventType").val())

        }
    });
</script>
