<script type="text/x-red" data-template-name="firebase.once">

    <div class="form-row">
        <label for="node-input-firebaseconfig"><i class="fa fa-database"></i> Firebase</label>
        <input type="text" id="node-input-firebaseconfig">
    </div>

    <div class="form-row">
        <label for="node-input-childpath"><i class="fa fa-sitemap"></i> Child Path</label>
        <input class="input-append-left" type="text" id="node-input-childpath" placeholder="path-to/the/data">
    </div>

    <div class="form-row">
      <label for="eventType-select"><i class="fa fa-terminal"></i> Event Type</label>
      .once("
      <select id="eventType-select" style="width:35%">
          <option value="value">value</option>
          <option value="child_added">child_added</option>
          <option value="child_changed">child_changed</option>
          <option value="child_removed">child_removed</option>
          <option value="child_moved">child_moved</option>
          <option value="shallow_query">shallow_query</option>
          <option value="msg.eventType">[msg.eventType]</option>
      </select>
      ")
      <input type="hidden" id="node-input-eventType">
    </div>

    <div class="form-row">
      <i class="fa fa-filter"></i> Query Parameters
    </div>

    <!-- //TODO: this node would be formatted nicer if #node-inpu-query-container-div was hidden until a query was added (or already present)... -->
    <div class="form-row node-input-query-container-row" style="margin-bottom: 0px;">
        <div id="node-input-query-container-div" style="box-sizing: border-box; border-radius: 5px; height: 260px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
            <ol id="node-input-query-container" style=" list-style-type:none; margin: 0;"></ol>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="btn btn-mini" id="node-input-add-query" style="margin-top: 4px;"><i class="fa fa-plus"></i> query</a>
    </div>

    <!-- By convention, most nodes have a 'name' property. The following div -->
    <!-- provides the necessary field. Should always be the last option      -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="firebase.once">
   <p>Get data from Firebase via firebase.once()</p> <!-- //TODO: this node needs documentation... -->
</script>

<script type="text/javascript">
    RED.nodes.registerType('firebase.once',{
        category: 'firebase',      // the palette category
        defaults: {             // defines the editable properties of the node
            name: {value:''},   //  along with default values.
            firebaseconfig:  {type:'firebase config',required:true},
            childpath: {value: '', required: false},
            eventType: {value: "value", required: true},
            queries: {value:[], required: true},
        },
        color: '#ffb37a',
        inputs:1,               // set the number of inputs - only 0 or 1
        outputs:1,              // set the number of outputs - 0 to n
        // set the icon (held in icons dir below where you save the node)
        icon: 'firebase.png',     // saved in  icons/myicon.png

        paletteLabel: "firebase.once()",

        label: function() {     // sets the default label contents
            //var config = RED.nodes.getNode(this.firebaseconfig);  //TODO: BUG: Doesn't appear to be a way to do this on the client side...

            // make sure the path starts with /
            var childpath = (this.childpath.indexOf("/") == 0) ? this.childpath : "/" + this.childpath;
            //make sure the path does not end with /
            childpath = childpath.substr(-1) == "/" ? childpath.slice(0,-1) : childpath

            //TODO: should we try to use the config nodes path and append to childpath or is that too long?
            return this.name ||
                   //"https://"+config.firebaseurl+"firebaseio.com/"+(this.childpath||"") + ".on(\""+this.eventType+"\")" ||
                   childpath + ".once(\""+this.eventType+"\")" ||
                   "firebase.once(\""+this.eventType+"\")";
        },
        labelStyle: function() { // sets the class to apply to the label
            return this.name?'node_label_italic':'';
        },

        oneditprepare: function() { //TODO: there is all kinds of validation that needs to be done to ensure only proper combinations of things are allowed...
          //Update the eventType node-red property when the value is changed...
          $('#eventType-select').change(function () {
              $("#node-input-eventType").val($(this).find('option:selected').val())
          });

          //Set the select's to the node-red hidden properties
          $("#eventType-select").val($("#node-input-eventType").val())

          //Most of this code is adapted from the switch node - https://raw.githubusercontent.com/node-red/node-red/master/nodes/core/logic/10-switch.html
          var operators = [
                // {v:"eq",t:"=="},
                // {v:"neq",t:"!="},
                // {v:"lt",t:"<"},
                // {v:"lte",t:"<="},
                // {v:"gt",t:">"},
                // {v:"gte",t:">="},
                // {v:"btwn",t:"is between"},
                // {v:"cont",t:"contains"},
                // {v:"regex",t:"matches regex"},
                // {v:"true",t:"is true"},
                // {v:"false",t:"is false"},
                // {v:"null",t:"is null"},
                // {v:"nnull",t:"is not null"},
                // {v:"else",t:"otherwise"},

                {v:"orderByChild", t:"orderByChild"},
                {v:"orderByKey", t:"orderByKey"},
                {v:"orderByValue", t:"orderByValue"},
                {v:"orderByPriority", t:"orderByPriority"},
                {v:"startAt", t:"startAt"},
                {v:"endAt", t:"endAt"},
                {v:"equalTo", t:"equalTo"},
                {v:"limitToFirst", t:"limitToFirst"},
                {v:"limitToLast", t:"limitToLast"},
                //{v:"limit", t:"limit"}  //deprecated

            ];

            //TODO: - Improve query support logic to not allow for invalid input.
            //TODO: hide query parameters if shallow_query is the event type (since they are not supported...)

            function generatequery(i,query) {
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top: 5px; text-align: right;"}).appendTo(container);
                $('<i style="color: #eee; cursor: move;" class="node-input-query-handle fa fa-bars"></i>').appendTo(row);

                var selectField = $('<select/>',{style:"width:150px; margin-left: 5px; text-align: center;"}).appendTo(row);
                for (var d in operators) {
                    selectField.append($("<option></option>").val(operators[d].v).text(operators[d].t));
                }

                var valueField = $('<input/>',{class:"node-input-query-value",type:"text",style:"margin-left: 5px; width: 250px;"}).appendTo(row);
                var btwnField = $('<span/>').appendTo(row);
                var btwnValueField = $('<input/>',{class:"node-input-query-btwn-value",type:"text",style:"margin-left: 5px; width: 75px;"}).appendTo(btwnField);
                btwnField.append(" and ");
                var btwnValue2Field = $('<input/>',{class:"node-input-query-btwn-value2",type:"text",style:"width: 75px;margin-left:2px;"}).appendTo(btwnField);

                // var finalspan = $('<span/>',{style:"float: right; margin-top: 3px;margin-right: 10px;"}).appendTo(row);
                // finalspan.append(' &#8594; <span class="node-input-query-index">'+i+'</span> ');

                // var deleteButton = $('<a/>',{href:"#",class:"btn btn-mini", style:"margin-left: 5px;"}).appendTo(finalspan);
                var deleteButton = $('<a/>',{href:"#",class:"btn btn-mini", style:"margin-left: 5px;"}).appendTo(row);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);

                selectField.change(function() {
                    var type = selectField.children("option:selected").val();
                    if (type.length < 4) {
                        selectField.css({"width":"60px"});
                    } else if (type === "regex") {
                        selectField.css({"width":"147px"});
                    } else {
                        selectField.css({"width":"150px"});
                    }
                    if (type === "btwn") {
                        valueField.hide();
                        btwnField.show();
                    } else {
                        btwnField.hide();
                        if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                            valueField.hide();
                        } else {
                            valueField.show();
                        }
                    }
                });


                deleteButton.click(function() {
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                        // $("#node-input-query-container").children().each(function(i) {
                        //     $(this).find(".node-input-query-index").html(i+1);
                        // });

                    });
                });

                $("#node-input-query-container").append(container);

                selectField.find("option").filter(function() {return $(this).val() == query.t;}).attr('selected',true);
                if (query.t == "btwn") {
                    btwnValueField.val(query.v);
                    btwnValue2Field.val(query.v2);
                } else if (typeof query.v != "undefined") {
                    valueField.val(query.v);
                }
                selectField.change();
            }

            $("#node-input-add-query").click(function() {
                generatequery($("#node-input-query-container").children().length+1,{t:"",v:"",v2:""});
                $("#node-input-query-container-div").scrollTop($("#node-input-query-container-div").get(0).scrollHeight);
            });

            if(this.queries){
              for (var i=0;i<this.queries.length;i++) {
                  var query = this.queries[i];
                  generatequery(i+1,query);
              }
            }


            function switchDialogResize() {
                var rows = $("#dialog-form>div:not(.node-input-query-container-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.size();i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-query-container-row");
                height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
                $("#node-input-query-container-div").css("height",height+"px");
            };

            $( "#node-input-query-container" ).sortable({
                axis: "y",
                // update: function( event, ui ) {
                //     var queries = $("#node-input-query-container").children();
                //     queries.each(function(i) {
                //         $(this).find(".node-input-query-index").html(i+1);
                //     });
                // },
                handle:".node-input-query-handle",
                cursor: "move"
            });
            $( "#node-input-query-container .node-input-query-handle" ).disableSelection();

            $( "#dialog" ).on("dialogresize", switchDialogResize);
            $( "#dialog" ).one("dialogopen", function(ev) {
                var size = $( "#dialog" ).dialog('option','sizeCache-switch');
                if (size) {
                    $("#dialog").dialog('option','width',size.width);
                    $("#dialog").dialog('option','height',size.height);
                    switchDialogResize();
                }
            });
            $( "#dialog" ).one("dialogclose", function(ev,ui) {
                $( "#dialog" ).off("dialogresize",switchDialogResize);
            });

        },

        oneditsave: function() {
            var queries = $("#node-input-query-container").children();
            var node = this;
            node.queries= [];
            queries.each(function(i) {
                var query = $(this);
                var type = query.find("select option:selected").val();
                var r = {t:type};
                if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else")) {
                    if (type === "btwn") {
                        r.v = query.find(".node-input-query-btwn-value").val();
                        r.v2 = query.find(".node-input-query-btwn-value2").val();
                    } else {
                        r.v = query.find(".node-input-query-value").val();
                    }
                }
                node.queries.push(r);
            });
            //node.outputs = node.queries.length;
        }
    });
</script>
