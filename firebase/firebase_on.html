<script type="text/x-red" data-template-name="firebase.on">

    <div class="form-row">
        <label for="node-input-firebaseconfig"><i class="fa fa-database"></i> Firebase</label>
        <input type="text" id="node-input-firebaseconfig">
    </div>

    <div class="form-row">
        <label for="node-input-childpath"><i class="fa fa-sitemap"></i> Child Path</label>
        <input class="input-append-left" type="text" id="node-input-childpath" placeholder="path-to/the/data">
    </div>

    <div class="form-row">
      <label for="eventType-select"><i class="fa fa-terminal"></i> Event Type</label>
      .on("
      <select id="eventType-select" style="width: 31%">
          <option value="value">value</option>
          <option value="child_added">child_added</option>
          <option value="child_changed">child_changed</option>
          <option value="child_removed">child_removed</option>
          <option value="child_moved">child_moved</option>
      </select>
      ")
      <input type="hidden" id="node-input-eventType">
    </div>

    <div class="form-row" id="node-atStart">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-atStart" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-atStart" style="width: 70%;">Fire last known data at start?</label>
    </div>

    <!-- By convention, most nodes have a 'name' property. The following div -->
    <!-- provides the necessary field. Should always be the last option      -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="firebase.on">
   <!-- data-help-name identifies the node type this help is for             -->
   <!-- This content appears in the Info sidebar when a node is selected     -->
   <!-- The first <p> is used as the pop-up tool tip when hovering over a    -->
   <!-- node in the palette.                                                 -->
   <p>Generate messages for Firebase .on() events.</p>

   <p>Supply a Firebase configuration and this node will watch for any changes at that location and generate messages.</p>

   <p>This node outputs an object called <b>msg</b> containing <b>msg.href</b>, <b>msg.key</b>, and
   <b>msg.payload</b>. Depending on the event type and data available <b>msg.priority</b>
   and <b>msg.previousChildName</b> may also be set:
   <ul>
     <li>
       <strong>msg.payload</strong> - the data returned from Firebase
       (The type of msg.payload depends on the data at that location)
     </li><br />
     <li>
       <strong>msg.href</strong> - the url of the data
     </li><br />
     <li>
       <strong>msg.key</strong> - the key of the Firebase data
     </li><br />
     <li>
       <strong><em>msg.priority</em></strong> - <em>(optional)</em> the priority of the Firebase data
     </li><br />
     <li>
       <strong><em>msg.previousChildName</em></strong> - <em>(optional)</em> the key for the previous child of the Firebase data
     </li>
   </ul>

   <p>This node can be backed by several different Firebase API methods:</p>
   <!-- https://www.firebase.com/docs/web/guide/retrieving-data.html -->
    <ul>
      <li>
        <strong>.on("value"):</strong>
        The <em>value</em> event is used to read a static snapshot of the contents at a given path, as they existed at the time of the read event.
        The flow is triggered once with the initial data (assuming the fire last known data at start box is checked) and again every time
        the data changes. <em>msg.payload</em> is passed a snapshot containing all data at that location, including child data.
      </li><br />
      <li>
        <strong>.on("child_added"):</strong>
        The <em>child_added</em> event is typically used when retrieving a list of items in Firebase.
        Unlike <em>value</em> events which returns the entire contents of the location, <em>child_added</em>
        is triggered once for each existing child and then again every time a new child is added to the specified path.
        <em>msg.payload</em> is passed a snapshot containing the new child's data. <!-- ' -->
      </li><br />
      <li>
        <strong>.on("child_changed"):</strong>
        The <em>child_changed</em> event is triggered any time a child node is modified.
        This includes any modifications to descendants of the child node. It is typically used in conjunction with
        <em>child_added</em> and <em>child_removed</em> to respond to changes to a list of items.
        <em>msg.payload</em> contains the updated data for the child.
      </li><br />
      <li>
        <strong>.on("child_removed"):</strong>
        The <em>child_removed</em> event is triggered when an immediate child is removed.
        It is typically used in conjunction with <em>child_added</em> and <em>child_changed</em>.
        <em>msg.payload</em> contains the data for the removed child.
      </li><br />
      <li>
        <strong>.on("child_moved"):</strong>
        The <em>child_moved</em> event is used when working with ordered data.
        This event type is used for advanced Firebase applications see
        <a href="https://www.firebase.com/docs/web/guide/retrieving-data.html#section-ordered-data">https://www.firebase.com/docs/web/guide/retrieving-data.html#section-ordered-data</a>
        for more information.
      </li>
    </ul>


</script>

<script type="text/javascript">
    RED.nodes.registerType('firebase.on',{
        category: 'firebase',      // the palette category
        defaults: {             // defines the editable properties of the node
            name: {value:''},   //  along with default values.
            firebaseconfig:  {type:'firebase config',required:true},
            childpath: {value: '', required: false},
            atStart: {value: true, required: true},
            eventType: {value: "value", required: true}
        },
        color: '#ffb37a',
        inputs:0,               // set the number of inputs - only 0 or 1
        outputs:1,              // set the number of outputs - 0 to n
        // set the icon (held in icons dir below where you save the node)
        icon: 'firebase.png',     // saved in  icons/myicon.png

        paletteLabel: "firebase.on()",

        label: function() {     // sets the default label contents
            //var config = RED.nodes.getNode(this.firebaseconfig);  //TODO: BUG: Doesn't appear to be a way to do this on the client side...

            // make sure the path starts with /
            var childpath = (this.childpath.indexOf("/") == 0) ? this.childpath : "/" + this.childpath;
            //make sure the path does not end with /
            childpath = childpath.substr(-1) == "/" ? childpath.slice(0,-1) : childpath

            //TODO: should we try to use the config nodes path and append to childpath or is that too long?
            return this.name ||
                   //"https://"+config.firebaseurl+"firebaseio.com/"+(this.childpath||"") + ".on(\""+this.eventType+"\")" ||
                   childpath + ".on(\""+this.eventType+"\")" ||
                   "firebase.on(\""+this.eventType+"\")";
        },
        labelStyle: function() { // sets the class to apply to the label
            return this.name?'node_label_italic':'';
        },

        oneditprepare: function() {
          //Update the eventType node-red property when the value is changed...
          $('#eventType-select').change(function () {
              $("#node-input-eventType").val($(this).find('option:selected').val())
          });

          //Set the select's to the node-red hidden properties
          $("#eventType-select").val($("#node-input-eventType").val())

        }
    });
</script>
